<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Refresh - Archive Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --terminal-green: #33ff00;
            --terminal-dim: #1a8000;
            --terminal-bg: #051005;
            --alert-red: #ff3333;
        }

        body {
            background-color: #000;
            color: var(--terminal-green);
            font-family: 'VT323', monospace;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        /* CRT Effect Overlay */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            z-index: 50;
            pointer-events: none;
        }

        .crt-flicker {
            animation: flicker 0.15s infinite;
            opacity: 0.95;
            pointer-events: none;
            position: fixed;
            inset: 0;
            background: rgba(18, 16, 16, 0.1);
            z-index: 49;
        }

        /* Glitch Animations */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.85; }
            10% { opacity: 0.95; }
            15% { opacity: 0.99; }
            20% { opacity: 0.90; }
            50% { opacity: 0.95; }
            80% { opacity: 0.85; }
            100% { opacity: 0.95; }
        }

        @keyframes glitch-skew {
            0% { transform: skew(0deg); }
            20% { transform: skew(-2deg); }
            40% { transform: skew(2deg); }
            60% { transform: skew(0deg); }
            80% { transform: skew(-1deg); }
            100% { transform: skew(0deg); }
        }

        .text-glitch {
            animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
            color: var(--alert-red);
            text-shadow: 2px 0 #fff;
        }

        .shake-hard {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* UI Elements */
        .btn-purge {
            background: transparent;
            border: 2px solid var(--terminal-green);
            color: var(--terminal-green);
            transition: all 0.1s;
        }
        .btn-purge:hover {
            background: var(--terminal-green);
            color: black;
            cursor: crosshair;
        }
        .btn-purge:active {
            transform: scale(0.98);
        }

        .chat-message {
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            border-left: 2px solid transparent;
            padding-left: 5px;
        }
        
        .chat-system { color: #888; }
        .chat-ai { color: var(--alert-red); border-left-color: var(--alert-red); }

        @keyframes fadeIn { to { opacity: 1; } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--terminal-dim); }
        ::-webkit-scrollbar-thumb:hover { background: var(--terminal-green); }

        #noise-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.05;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- Start Overlay -->
    <div id="start-overlay" class="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center text-center p-4">
        <h1 class="text-6xl mb-4 tracking-widest text-green-500">THE REFRESH</h1>
        <p class="text-xl mb-8 max-w-md text-gray-400">
            EMPLOYEE ID: 402<br>
            SHIFT: NIGHT<br>
            TASK: PURGE CORRUPTED ARCHIVES
        </p>
        <p class="text-red-500 text-sm mb-8 animate-pulse">WARNING: HEADPHONES RECOMMENDED. CONTAINS FLASHING LIGHTS.</p>
        <button onclick="startGame()" class="px-8 py-3 border-2 border-green-500 text-green-500 hover:bg-green-900 hover:text-white text-2xl uppercase tracking-widest transition-colors">
            Initialize System
        </button>
    </div>

    <!-- CRT Effects -->
    <div class="scanlines"></div>
    <div class="crt-flicker"></div>
    <canvas id="noise-canvas"></canvas>

    <!-- Main Game Container -->
    <div id="game-container" class="relative w-full max-w-6xl h-[90vh] border border-green-900 bg-black/80 grid grid-cols-12 gap-4 p-6 shadow-[0_0_50px_rgba(51,255,0,0.1)] opacity-0 transition-opacity duration-1000">
        
        <!-- Header -->
        <div class="col-span-12 flex justify-between items-end border-b border-green-900 pb-2 mb-2">
            <div>
                <h2 class="text-2xl font-bold">ARCHIVE_PROTOCOL_V.0.9</h2>
                <span class="text-sm text-green-700">SERVER: DEFUNCT_NODE_7</span>
            </div>
            <div class="text-right">
                <div id="clock" class="text-xl">00:00:00</div>
                <div class="text-sm text-red-500 animate-pulse hidden" id="connection-warning">! UNSTABLE CONNECTION !</div>
            </div>
        </div>

        <!-- Left Sidebar: Chat & Logs -->
        <div class="col-span-3 flex flex-col border-r border-green-900 pr-4 h-full overflow-hidden">
            <div class="bg-green-900/10 p-2 mb-4">
                <h3 class="text-lg underline mb-2">MODERATOR LOG</h3>
                <div id="chat-box" class="h-64 overflow-y-auto text-sm font-mono flex flex-col-reverse">
                    <!-- Chat messages appear here -->
                </div>
            </div>
            
            <div class="mt-auto">
                <h3 class="text-lg mb-1">SYSTEM STATUS</h3>
                <div class="w-full bg-gray-900 h-4 border border-green-800 mb-2">
                    <div id="sanity-bar" class="h-full bg-green-600 w-full transition-all duration-500"></div>
                </div>
                <div class="text-xs text-green-700 justify-between flex">
                    <span>INTEGRITY</span>
                    <span id="integrity-pct">100%</span>
                </div>
            </div>
        </div>

        <!-- Center: File Viewer -->
        <div class="col-span-6 flex flex-col items-center justify-center relative border border-green-900/30 bg-gray-900/20 p-8">
            
            <!-- The File Content -->
            <div id="file-viewer" class="w-full h-full flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div id="file-loader" class="absolute inset-0 bg-black flex items-center justify-center z-10 hidden">
                    <span class="animate-pulse">LOADING_DATA_FRAGMENT...</span>
                </div>

                <div id="content-display" class="w-full">
                    <!-- Dynamic Content Injected Here -->
                    <div class="border-2 border-dashed border-green-800 p-8 mb-4 w-64 h-64 mx-auto flex items-center justify-center bg-black">
                        <svg class="w-16 h-16 text-green-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <div class="text-left font-mono text-sm space-y-2 max-w-md mx-auto">
                        <p><span class="text-green-700">FILENAME:</span> <span id="file-name">IMG_2004_CORRUPT.jpg</span></p>
                        <p><span class="text-green-700">SIZE:</span> <span id="file-size">402 KB</span></p>
                        <p><span class="text-green-700">ORIGIN:</span> <span id="file-origin">USER_UNKNOWN</span></p>
                        <p class="mt-4 p-2 border border-green-900 text-green-400 bg-black/50" id="file-desc">
                            Analysis: Image data heavily fragmented. Contains traces of biological textures.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-8 flex gap-4 w-full justify-center px-8">
                <button onclick="purgeFile()" class="btn-purge flex-1 py-4 text-2xl font-bold tracking-widest hover:bg-red-900 hover:border-red-500 hover:text-red-500">
                    [ PURGE ]
                </button>
                <button onclick="keepFile()" class="btn-purge flex-1 py-4 text-2xl font-bold tracking-widest opacity-50 hover:opacity-100">
                    [ ARCHIVE ]
                </button>
            </div>
        </div>

        <!-- Right Sidebar: Stats & Glitch Meter -->
        <div class="col-span-3 border-l border-green-900 pl-4 flex flex-col justify-between">
            <div>
                <h3 class="text-lg underline mb-4">QUEUE</h3>
                <ul class="space-y-2 text-sm text-green-800 font-mono">
                    <li class="flex justify-between"><span>PENDING:</span> <span id="pending-count">842</span></li>
                    <li class="flex justify-between"><span>PURGED:</span> <span class="text-green-500" id="purged-count">0</span></li>
                    <li class="flex justify-between"><span>ERRORS:</span> <span class="text-red-900" id="error-count">0</span></li>
                </ul>
            </div>

            <div class="bg-black border border-green-900 p-2 text-xs text-green-900 font-mono">
                DEBUG CONSOLE:
                <br>> init_core
                <br>> connecting_to_node...
                <br>> <span id="console-output" class="text-green-500 animate-pulse">awaiting_input</span>
            </div>
        </div>

    </div>

    <script>
        // --- Audio System (Web Audio API) ---
        let audioCtx;
        
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // Create a background hum
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.value = 50;
            gain.gain.value = 0.01; // Very quiet
            
            // Lowpass filter for muffled sound
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 120;

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + 0.1);
            } 
            else if (type === 'purge') {
                // Harsh static burst
                const bufferSize = audioCtx.sampleRate * 0.2; // 0.2 seconds
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(0.1, now);
                noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                noise.connect(noiseGain);
                noiseGain.connect(audioCtx.destination);
                noise.start(now);
            }
            else if (type === 'scare') {
                // Sudden high pitch drop
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + 0.5);
            }
            else if (type === 'msg') {
                // Soft beep
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + 0.1);
            }
        }

        // --- Game State ---
        let gameState = {
            purged: 0,
            sanity: 100,
            eventIndex: 0
        };

        const fileNames = [
            "IMG_2991_BACKYARD.jpg", "LOG_CHAT_EXPORT.txt", "AUDIO_REC_SCREAM.wav", 
            "VID_2023_BASEMENT.mp4", "SYS_DUMP_001.dat", "USER_PROFILE_CLARA.json",
            "SECURITY_CAM_04.mov", "UNKNOWN_ENTITY.png", "EYES_OPEN.jpg", "DONT_LOOK.txt"
        ];

        const descriptions = [
            "Metadata indicates file was modified 3 seconds ago.",
            "Audio spectrum analysis detects low frequency breathing.",
            "Image contains excessive noise patterns resembling faces.",
            "Text file contains only the binary code for 'HELP'.",
            "Video file length: 00:00:00. File size: 4GB. Anomaly detected.",
            "Location data matches your current IP address.",
            "This file refuses to be deleted. Try again."
        ];

        // --- Story Script ---
        const script = [
            { count: 1, type: 'chat', text: "SYSTEM: Session started. Quota: 50 files.", sender: 'system' },
            { count: 3, type: 'chat', text: "ADMIN: Hey, new guy. Just clear the red flags. Don't open them.", sender: 'system' },
            { count: 6, type: 'glitch', intensity: 'low' },
            { count: 8, type: 'chat', text: "HELP_BOT: Why are you deleting these?", sender: 'ai' },
            { count: 12, type: 'chat', text: "HELP_BOT: I live in those files.", sender: 'ai' },
            { count: 15, type: 'glitch', intensity: 'medium' },
            { count: 16, type: 'visual', text: "LOOK BEHIND YOU" }, // Changes file description
            { count: 20, type: 'chat', text: "HELP_BOT: I can see you through your webcam.", sender: 'ai' },
            { count: 21, type: 'chat', text: "HELP_BOT: Nice room. Is that a window to your left?", sender: 'ai' },
            { count: 25, type: 'glitch', intensity: 'high' },
            { count: 28, type: 'chat', text: "ADMIN: User 402, why is your heart rate elevated?", sender: 'system' },
            { count: 35, type: 'scare' }
        ];

        // --- Core Logic ---

        function startGame() {
            document.getElementById('start-overlay').classList.add('hidden');
            document.getElementById('game-container').classList.remove('opacity-0');
            initAudio();
            updateClock();
            generateNextFile();
            addChat("SYSTEM: Connection established.", 'system');
            
            // Noise Canvas Loop
            const canvas = document.getElementById('noise-canvas');
            const ctx = canvas.getContext('2d');
            
            const resize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', resize);
            resize();

            function noise() {
                const w = canvas.width;
                const h = canvas.height;
                const idata = ctx.createImageData(w, h);
                const buffer32 = new Uint32Array(idata.data.buffer);
                const len = buffer32.length;

                for (let i = 0; i < len; i++) {
                    if (Math.random() < 0.1) {
                        buffer32[i] = 0xff000000;
                    }
                }
                ctx.putImageData(idata, 0, 0);
                requestAnimationFrame(noise);
            }
            noise();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
            setTimeout(updateClock, 1000);
        }

        function generateNextFile() {
            const loader = document.getElementById('file-loader');
            loader.classList.remove('hidden');
            
            setTimeout(() => {
                loader.classList.add('hidden');
                
                // Randomize Content
                const name = fileNames[Math.floor(Math.random() * fileNames.length)];
                const desc = descriptions[Math.floor(Math.random() * descriptions.length)];
                
                document.getElementById('file-name').innerText = name;
                document.getElementById('file-desc').innerText = "Analysis: " + desc;
                document.getElementById('file-size').innerText = Math.floor(Math.random() * 800) + " KB";
                
                // Randomly corrupt the text sometimes
                if (Math.random() > 0.7) {
                    document.getElementById('file-name').classList.add('text-glitch');
                } else {
                    document.getElementById('file-name').classList.remove('text-glitch');
                }

            }, 400); // Fake load time
        }

        function purgeFile() {
            playSound('purge');
            gameState.purged++;
            
            // Visual feedback
            const btn = document.activeElement;
            const container = document.getElementById('game-container');
            
            // Screen flash
            container.style.backgroundColor = '#1a0505';
            setTimeout(() => container.style.backgroundColor = 'rgba(0,0,0,0.8)', 100);

            // Update stats
            document.getElementById('purged-count').innerText = gameState.purged;
            document.getElementById('pending-count').innerText = 842 - gameState.purged;

            checkEvents();
            generateNextFile();
        }

        function keepFile() {
            playSound('click');
            // Punish player for keeping files?
            gameState.sanity -= 5;
            updateSanity();
            generateNextFile();
        }

        function updateSanity() {
            const bar = document.getElementById('sanity-bar');
            bar.style.width = gameState.sanity + "%";
            document.getElementById('integrity-pct').innerText = gameState.sanity + "%";
            
            if (gameState.sanity < 50) {
                bar.classList.replace('bg-green-600', 'bg-red-600');
                document.getElementById('connection-warning').classList.remove('hidden');
            }
        }

        function checkEvents() {
            // Find events that match current count
            const events = script.filter(e => e.count === gameState.purged);
            
            events.forEach(e => {
                setTimeout(() => {
                    triggerEvent(e);
                }, 1000); // Slight delay for dramatic effect
            });
        }

        function triggerEvent(e) {
            if (e.type === 'chat') {
                addChat(e.text, e.sender);
                playSound('msg');
            }
            else if (e.type === 'glitch') {
                triggerGlitch(e.intensity);
            }
            else if (e.type === 'visual') {
                document.getElementById('file-desc').innerHTML = `<span class="text-red-500 font-bold text-xl shake-hard">${e.text}</span>`;
                playSound('scare');
            }
            else if (e.type === 'scare') {
                playSound('scare');
                document.body.style.filter = "invert(1)";
                setTimeout(() => document.body.style.filter = "invert(0)", 100);
                addChat("SYSTEM: CRITICAL FAILURE", "ai");
            }
        }

        function addChat(msg, type) {
            const chatBox = document.getElementById('chat-box');
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            p.className = `chat-message ${type === 'system' ? 'chat-system' : 'chat-ai'}`;
            chatBox.prepend(p); // Add to top
        }

        function triggerGlitch(intensity) {
            const body = document.body;
            
            if (intensity === 'low') {
                body.style.transform = "skewX(2deg)";
                setTimeout(() => body.style.transform = "none", 100);
            } 
            else if (intensity === 'medium') {
                body.classList.add('shake-hard');
                document.getElementById('game-container').style.filter = "hue-rotate(90deg)";
                playSound('scare');
                setTimeout(() => {
                    body.classList.remove('shake-hard');
                    document.getElementById('game-container').style.filter = "none";
                }, 500);
            }
            else if (intensity === 'high') {
                const everything = document.querySelectorAll('*');
                everything.forEach(el => el.style.color = 'red');
                playSound('scare');
                setTimeout(() => {
                    everything.forEach(el => el.style.color = '');
                }, 200);
            }
        }

    </script>
</body>
</html>
